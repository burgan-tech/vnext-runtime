services:

  vnext-app:
    container_name: vnext-app
    image: "ghcr.io/burgan-tech/vnext/orchestrator:${VNEXT_ORCHESTRATOR_VERSION:-latest}"
    env_file:
      - .env.orchestration
    volumes:
      - ./appsettings.Development.json:/app/appsettings.Development.json:ro
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://vnext-app:5000/health" ]
      interval: 10s
      retries: 5
      start_period: 35s
      timeout: 30s
    ports:
      - "4201:5000"
    networks:
      - vnext-development
    depends_on:
      - dapr-placement
      - dapr-scheduler
      - postgres

  # VNext Core Runtime Initializer - vnext-app loads system components after it is healthy
  vnext-core-init:
    container_name: vnext-core-init
    image: "ghcr.io/burgan-tech/vnext/init:${VNEXT_VERSION:-latest}"
    environment:
      VNEXT_COMPONENT_VERSION: "${VNEXT_COMPONENT_VERSION:-latest}"
      VNEXT_APP_URL: "http://vnext-app:5000"
      APP_DOMAIN: "${APP_DOMAIN:-core}"
    volumes:
      - npm-cache:/app/.npm-cache
      # Custom components volume - users can mount their components here
      - "${CUSTOM_COMPONENTS_PATH:-./custom-components}:/app/custom-components"
    networks:
      - vnext-development
    depends_on:
      vnext-app:
        condition: service_healthy
    restart: "no"
      
  vnext-execution-app:
    container_name: vnext-execution-app
    image: "ghcr.io/burgan-tech/vnext/execution:${VNEXT_VERSION:-latest}"
    env_file:
      - .env.execution
    volumes:
      - ./appsettings.Execution.Development.json:/app/appsettings.Development.json:ro
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://vnext-execution-app:5000/health" ]
      interval: 10s
      retries: 5
      start_period: 35s
      timeout: 30s
    ports:
      - "4202:5000"
    networks:
      - vnext-development
    depends_on:
      vnext-app:
        condition: service_healthy
      dapr-placement:
        condition: service_started
      dapr-scheduler:
        condition: service_started
      postgres:
        condition: service_started

  vnext-orchestration-dapr:
    image: "daprio/daprd:${DAPR_RUNTIME_VERSION:-latest}"
    container_name: vnext-orchestration-dapr
    command: [
      "./daprd",
      "--app-id", "vnext-app",
      "--app-port", "5000",
      "--resources-path", "./components",
      "--dapr-grpc-port", "42111",
      "--dapr-http-port", "42110",
      "--scheduler-host-address", "dapr-scheduler:50007",
      "--placement-host-address", "dapr-placement:50005"
    ]
    volumes:
      - "../orchestration/dapr/components:/components"
    network_mode: "service:vnext-app"
    depends_on:
      - vnext-app
      - dapr-placement
      - dapr-scheduler
      - redis
      - vault
        
  vnext-execution-dapr:
    image: "daprio/daprd:${DAPR_RUNTIME_VERSION:-latest}"
    container_name: vnext-execution-dapr
    command: [
      "./daprd",
      "--app-id", "vnext-execution-app",
      "--app-port", "5000",
      "--resources-path", "./components",
      "--dapr-grpc-port", "43111",
      "--dapr-http-port", "43110",
      "--scheduler-host-address", "dapr-scheduler:50007",
      "--placement-host-address", "dapr-placement:50005"
    ]
    volumes:
      - "../execution/dapr/components:/components"
    network_mode: "service:vnext-execution-app"
    depends_on:
      - vnext-execution-app
      - dapr-placement
      - dapr-scheduler
      - redis
      - vault

  vnext-worker-inbox:
    container_name: vnext-worker-inbox
    image: "ghcr.io/burgan-tech/vnext/inbox:${VNEXT_VERSION:-latest}"
    env_file:
      - .env.worker-inbox
    volumes:
      - ./appsettings.WorkerInbox.Development.json:/app/appsettings.Development.json:ro
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://vnext-worker-inbox:5000/health" ]
      interval: 10s
      retries: 5
      start_period: 35s
      timeout: 30s
    ports:
      - "4203:5000"
    networks:
      - vnext-development
    depends_on:
      vnext-app:
        condition: service_healthy
      dapr-placement:
        condition: service_started
      dapr-scheduler:
        condition: service_started
      postgres:
        condition: service_started

  vnext-worker-inbox-dapr:
    image: "daprio/daprd:${DAPR_RUNTIME_VERSION:-latest}"
    container_name: vnext-worker-inbox-dapr
    command: [
      "./daprd",
      "--app-id", "vnext-worker-inbox",
      "--app-port", "5000",
      "--resources-path", "./components",
      "--dapr-grpc-port", "44111",
      "--dapr-http-port", "44110",
      "--scheduler-host-address", "dapr-scheduler:50007",
      "--placement-host-address", "dapr-placement:50005"
    ]
    volumes:
      - "../worker-inbox/dapr/components:/components"
    network_mode: "service:vnext-worker-inbox"
    depends_on:
      - vnext-worker-inbox
      - dapr-placement
      - dapr-scheduler
      - redis
      - vault

  vnext-worker-outbox:
    container_name: vnext-worker-outbox
    image: "ghcr.io/burgan-tech/vnext/outbox:${VNEXT_VERSION:-latest}"
    env_file:
      - .env.worker-outbox
    volumes:
      - ./appsettings.WorkerOutbox.Development.json:/app/appsettings.Development.json:ro
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://vnext-worker-outbox:5000/health" ]
      interval: 10s
      retries: 5
      start_period: 35s
      timeout: 30s
    ports:
      - "4204:5000"
    networks:
      - vnext-development
    depends_on:
      vnext-app:
        condition: service_healthy
      dapr-placement:
        condition: service_started
      dapr-scheduler:
        condition: service_started
      postgres:
        condition: service_started

  vnext-worker-outbox-dapr:
    image: "daprio/daprd:${DAPR_RUNTIME_VERSION:-latest}"
    container_name: vnext-worker-outbox-dapr
    command: [
      "./daprd",
      "--app-id", "vnext-worker-outbox",
      "--app-port", "5000",
      "--resources-path", "./components",
      "--dapr-grpc-port", "45111",
      "--dapr-http-port", "45110",
      "--scheduler-host-address", "dapr-scheduler:50007",
      "--placement-host-address", "dapr-placement:50005"
    ]
    volumes:
      - "../worker-outbox/dapr/components:/components"
    network_mode: "service:vnext-worker-outbox"
    depends_on:
      - vnext-worker-outbox
      - dapr-placement
      - dapr-scheduler
      - redis
      - vault

  dapr-placement:
    image: "daprio/dapr:${DAPR_PLACEMENT_VERSION:-latest}"
    container_name: dapr-placement
    command: ["./placement"]
    ports:
      - "50005:50005"
    networks:
      - vnext-development

  dapr-scheduler:
    image: "daprio/scheduler:${DAPR_SCHEDULER_VERSION:-latest}"
    container_name: dapr-scheduler
    user: "0:0"
    command: [
      "./scheduler",
      "--port",
      "50007",
      "--etcd-data-dir",
      "/data"
    ]
    ports:
      - "50007:50007"
    volumes:
      - type: tmpfs
        target: /data
        tmpfs:
          size: "64m"
          mode: 1777
    networks:
      - vnext-development

  redis:
    container_name: vnext-redis
    image: "redis:${REDIS_VERSION:-latest}"
    restart: always
    ports:
      - '6379:6379'
    command: redis-server --save 20 1 --loglevel warning
    # volumes:
    #   - redis:/data
    networks:
      - vnext-development

  redis-insight:
    container_name: vnext-red-insight
    image: "redislabs/redisinsight:${REDIS_INSIGHT_VERSION:-latest}"
    ports:
      - '5501:8001'
    # volumes:
    #   - redis-insight:/db
    restart: unless-stopped
    networks:
      - vnext-development

  postgres:
    container_name: vnext-postgres
    image: "postgres:${POSTGRES_VERSION:-latest}"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      PGDATA: /data/postgres
    volumes:
      - postgres:/data/postgres
    ports:
      - "5432:5432"
    restart: unless-stopped
    networks:
      - vnext-development

  pgadmin:
    container_name: vnext-pgadmin
    image: "dpage/pgadmin4:${PGADMIN_VERSION:-latest}"
    environment:
      PGADMIN_DEFAULT_EMAIL: "info@info.com"
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    volumes:
      - pgadmin:/var/lib/pgadmin
    ports:
      - "5502:80"
    restart: unless-stopped
    networks:
      - vnext-development
  
  vault:
    container_name: vnext-vault
    image: "vault:${VAULT_VERSION:-1.13.3}"
    restart: on-failure:10
    ports:
      - "8200:8200"
    environment:
      VAULT_ADDR: 'https://0.0.0.0:8200'
      VAULT_API_ADDR: 'https://0.0.0.0:8200'
      VAULT_DEV_ROOT_TOKEN_ID: 'admin'
      VAULT_TOKEN: 'admin'
    volumes:
      - ./config/vault:/vault/file
    cap_add:
      - IPC_LOCK
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--spider",
          "--proxy",
          "off",
          "http://vault:8200/v1/sys/health?standbyok=true",
        ]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    command: server -dev -dev-root-token-id="admin"
    networks:
      - vnext-development

  vault-prepopulate:
    image: "alpine/curl:${ALPINE_CURL_VERSION:-latest}"
    depends_on:
      - vault
    volumes:
      - ./config/vault/vault.sh:/etc/vault/prepopulate_vault.sh
    command: ["sh", "-c", "chmod +x /etc/vault/prepopulate_vault.sh && /etc/vault/prepopulate_vault.sh"]
    networks:
      - vnext-development

  # OpenObserve for observability
  openobserve:
    container_name: vnext-openobserve
    image: "public.ecr.aws/zinclabs/openobserve:${OPENOBSERVE_VERSION:-latest}"
    environment:
      ZO_ROOT_USER_EMAIL: "root@example.com"
      ZO_ROOT_USER_PASSWORD: "Complexpass#@123"
      ZO_DATA_DIR: "/data"
    ports:
      - "5080:5080"
    volumes:
      - openobserve:/data
    networks:
      - vnext-development

  # OpenTelemetry Collector
  otel-collector:
    container_name: vnext-otel-collector
    image: "otel/opentelemetry-collector-contrib:${OTEL_COLLECTOR_VERSION:-latest}"
    volumes:
      - ./config/otel/otel-config.yaml:/etc/otelcol-contrib/config.yaml
    ports:
      - "1888:1888" # pprof extension
      - "8888:8888" # Prometheus metrics exposed by the Collector
      - "8889:8889" # Prometheus exporter metrics
      - "13133:13133" # health_check extension
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP http receiver
      - "55679:55679" # zpages extension
    depends_on:
      - openobserve
    networks:
      - vnext-development

  prometheus:
    container_name: vnext-prometheus
    image: prom/prometheus:${PROMETHEUS_VERSION:-latest}
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--storage.tsdb.retention.time=200h"
      - "--web.enable-lifecycle"
    volumes:
      - ./config/prometheus:/etc/prometheus
      - prometheus:/prometheus
    ports:
      - "9090:9090"
    networks:
      - vnext-development
    restart: unless-stopped

  grafana:
    container_name: vnext-grafana
    image: grafana/grafana:${GRAFANA_VERSION:-latest}
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: 'false'
    volumes:
      - grafana:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards
    ports:
      - "3000:3000"
    networks:
      - vnext-development
    depends_on:
      - prometheus
    restart: unless-stopped

  metabase:
    container_name: vnext-metabase
    image: metabase/metabase:${METABASE_VERSION:-latest}
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 5432
      MB_DB_USER: postgres
      MB_DB_PASS: postgres
      MB_DB_HOST: postgres
      MB_ENCRYPTION_SECRET_KEY: "vnext-metabase-secret-key-change-this-in-production"
      JAVA_OPTS: "-Xmx2g"
    ports:
      - "3002:3000"
    volumes:
      - metabase:/metabase.db
      - ../../metabase-dashboards:/metabase-dashboards:ro
    networks:
      - vnext-development
    depends_on:
      - postgres
    restart: unless-stopped
    healthcheck:
      test: curl --fail -I http://localhost:3000/api/health || exit 1
      interval: 30s
      timeout: 5s
      retries: 5

  clickhouse:
    container_name: vnext-clickhouse
    image: clickhouse/clickhouse-server:${CLICKHOUSE_VERSION:-latest}
    environment:
      CLICKHOUSE_DB: workflow_analytics
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native interface
    volumes:
      - clickhouse:/var/lib/clickhouse
      - ./config/clickhouse:/etc/clickhouse-server/config.d
      - ./config/clickhouse/users.xml:/etc/clickhouse-server/users.xml
      - ./config/clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - vnext-development
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Mockoon API Mock Server
  mockoon:
    image: mockoon/cli:${MOCKOON_VERSION:-latest}
    container_name: migration-mockoon
    command: ["--data", "/data/migration-api.json", "--port", "3001", "--hostname", "0.0.0.0"]
    ports:
      - "3001:3001"
    volumes:
      - ./config/mockoon:/data
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - vnext-development


  mockoon-dapr:
    image: "daprio/daprd:${DAPR_RUNTIME_VERSION:-latest}"
    container_name: mockoon-dapr
    command:
      [
        "./daprd",
        "--app-id", "mockoon",
        "--app-port", "3000",
        "--resources-path", "./components",
        "--dapr-grpc-port", "3501",
        "--dapr-http-port", "3500",
        "--scheduler-host-address", "dapr-scheduler:50007",
        "--placement-host-address", "dapr-placement:50005"
      ]
    volumes:
      - "../mockoon/dapr/components:/components"
    network_mode: "service:mockoon"
    depends_on:
      - mockoon
      - dapr-placement
      - dapr-scheduler
      
networks:
  vnext-development:
    external: true

volumes:
  # redis:
  # redis-insight:
  postgres:
  pgadmin:
  openobserve:
  prometheus:
  grafana:
  metabase:
  clickhouse:
  npm-cache: {}