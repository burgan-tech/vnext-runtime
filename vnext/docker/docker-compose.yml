# VNext Runtime Docker Compose
# Supports multiple domains running simultaneously with shared infrastructure
#
# Infrastructure (profile: infra) - Run once, shared by all domains
# VNext Apps (profile: vnext) - Run per domain with unique project name
#
# Usage:
#   make up-infra                    # Start shared infrastructure
#   make up-vnext DOMAIN=core        # Start vnext for 'core' domain
#   make up-vnext DOMAIN=sales       # Start vnext for 'sales' domain
#
# Domain configuration files are stored in: domains/<domain_name>/
x-vnext-common: &vnext-common
  networks:
    - vnext-development
services:
  # ============================================================================
  # VNEXT APPLICATIONS - Profile: vnext
  # Note: Infrastructure must be running before starting vnext services
  # ============================================================================
  vnext-app:
    container_name: vnext-app-${DOMAIN_NAME:-core}
    image: "ghcr.io/burgan-tech/vnext/orchestrator:${VNEXT_VERSION:-latest}"
    profiles:
      - vnext
    env_file:
      - ./domains/${DOMAIN_NAME:-core}/.env.orchestration
    environment:
      - APP_DOMAIN=${DOMAIN_NAME:-core}
    volumes:
      - ./domains/${DOMAIN_NAME:-core}/appsettings.Development.json:/app/appsettings.Development.json:ro
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health" ]
      interval: 10s
      retries: 5
      start_period: 35s
      timeout: 30s
    ports:
      - "${VNEXT_APP_PORT:-4201}:5000"
    <<: *vnext-common
  vnext-init:
    container_name: vnext-init-${DOMAIN_NAME:-core}
    image: "ghcr.io/burgan-tech/vnext/init:${VNEXT_VERSION:-latest}"
    profiles:
      - vnext
    environment:
      VNEXT_APP_URL: "http://vnext-app-${DOMAIN_NAME:-core}:5000"
      PACKAGE_API_PORT: 3000
      NPM_REGISTRY: "https://registry.npmjs.org/"
      DOMAIN_NAME: ${DOMAIN_NAME:-core}
    volumes:
      - npm-cache-${DOMAIN_NAME:-core}:/app/.npm-cache
    ports:
      - "${VNEXT_INIT_PORT:-3005}:3000"
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:3000/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    <<: *vnext-common
    depends_on:
      vnext-app:
        condition: service_healthy
    restart: "no"
  vnext-component-publisher:
    container_name: vnext-component-publisher-${DOMAIN_NAME:-core}
    image: "alpine/curl:${ALPINE_CURL_VERSION:-latest}"
    profiles:
      - vnext
    env_file:
      - ./domains/${DOMAIN_NAME:-core}/.env
    environment:
      VNEXT_INIT_URL: "http://vnext-init-${DOMAIN_NAME:-core}:3000"
    volumes:
      - ./publish-component.sh:/scripts/publish-component.sh:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Publishing components to vnext-init..."
        apk add --no-cache bash > /dev/null 2>&1
        /bin/bash /scripts/publish-component.sh --skip-health --url "$$VNEXT_INIT_URL"
    <<: *vnext-common
    depends_on:
      vnext-init:
        condition: service_healthy
    restart: "no"
  vnext-execution-app:
    container_name: vnext-execution-app-${DOMAIN_NAME:-core}
    image: "ghcr.io/burgan-tech/vnext/execution:${VNEXT_VERSION:-latest}"
    profiles:
      - vnext
    env_file:
      - ./domains/${DOMAIN_NAME:-core}/.env.execution
    environment:
      - APP_DOMAIN=${DOMAIN_NAME:-core}
    volumes:
      - ./domains/${DOMAIN_NAME:-core}/appsettings.Execution.Development.json:/app/appsettings.Development.json:ro
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health" ]
      interval: 10s
      retries: 5
      start_period: 35s
      timeout: 30s
    ports:
      - "${VNEXT_EXECUTION_PORT:-4202}:5000"
    <<: *vnext-common
  vnext-orchestration-dapr:
    image: "daprio/daprd:${DAPR_RUNTIME_VERSION:-latest}"
    container_name: vnext-orchestration-dapr-${DOMAIN_NAME:-core}
    profiles:
      - vnext
    command: [
      "./daprd",
      "--app-id", "vnext-app-${DOMAIN_NAME:-core}",
      "--app-port", "5000",
      "--resources-path", "./components",
      "--dapr-grpc-port", "${DAPR_ORCHESTRATION_GRPC_PORT:-42111}",
      "--dapr-http-port", "${DAPR_ORCHESTRATION_HTTP_PORT:-42110}",
      "--scheduler-host-address", "dapr-scheduler:50007",
      "--placement-host-address", "dapr-placement:50005"
    ]
    volumes:
      - "../orchestration/dapr/components:/components"
    network_mode: "service:vnext-app"
    depends_on:
      - vnext-app
  vnext-execution-dapr:
    image: "daprio/daprd:${DAPR_RUNTIME_VERSION:-latest}"
    container_name: vnext-execution-dapr-${DOMAIN_NAME:-core}
    profiles:
      - vnext
    command: [
      "./daprd",
      "--app-id", "vnext-execution-app-${DOMAIN_NAME:-core}",
      "--app-port", "5000",
      "--resources-path", "./components",
      "--dapr-grpc-port", "${DAPR_EXECUTION_GRPC_PORT:-43111}",
      "--dapr-http-port", "${DAPR_EXECUTION_HTTP_PORT:-43110}",
      "--scheduler-host-address", "dapr-scheduler:50007",
      "--placement-host-address", "dapr-placement:50005"
    ]
    volumes:
      - "../execution/dapr/components:/components"
    network_mode: "service:vnext-execution-app"
    depends_on:
      - vnext-execution-app
  vnext-worker-inbox:
    container_name: vnext-worker-inbox-${DOMAIN_NAME:-core}
    image: "ghcr.io/burgan-tech/vnext/inbox:${VNEXT_VERSION:-latest}"
    profiles:
      - vnext
    env_file:
      - ./domains/${DOMAIN_NAME:-core}/.env.worker-inbox
    environment:
      - APP_DOMAIN=${DOMAIN_NAME:-core}
    volumes:
      - ./domains/${DOMAIN_NAME:-core}/appsettings.WorkerInbox.Development.json:/app/appsettings.Development.json:ro
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health" ]
      interval: 10s
      retries: 5
      start_period: 35s
      timeout: 30s
    ports:
      - "${VNEXT_INBOX_PORT:-4203}:5000"
    <<: *vnext-common
  vnext-worker-inbox-dapr:
    image: "daprio/daprd:${DAPR_RUNTIME_VERSION:-latest}"
    container_name: vnext-worker-inbox-dapr-${DOMAIN_NAME:-core}
    profiles:
      - vnext
    command: [
      "./daprd",
      "--app-id", "vnext-worker-inbox-${DOMAIN_NAME:-core}",
      "--app-port", "5000",
      "--resources-path", "./components",
      "--dapr-grpc-port", "${DAPR_INBOX_GRPC_PORT:-44111}",
      "--dapr-http-port", "${DAPR_INBOX_HTTP_PORT:-44110}",
      "--scheduler-host-address", "dapr-scheduler:50007",
      "--placement-host-address", "dapr-placement:50005"
    ]
    volumes:
      - "../worker-inbox/dapr/components:/components"
    network_mode: "service:vnext-worker-inbox"
    depends_on:
      - vnext-worker-inbox
  vnext-worker-outbox:
    container_name: vnext-worker-outbox-${DOMAIN_NAME:-core}
    image: "ghcr.io/burgan-tech/vnext/outbox:${VNEXT_VERSION:-latest}"
    profiles:
      - vnext
    env_file:
      - ./domains/${DOMAIN_NAME:-core}/.env.worker-outbox
    environment:
      - APP_DOMAIN=${DOMAIN_NAME:-core}
    volumes:
      - ./domains/${DOMAIN_NAME:-core}/appsettings.WorkerOutbox.Development.json:/app/appsettings.Development.json:ro
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health" ]
      interval: 10s
      retries: 5
      start_period: 35s
      timeout: 30s
    ports:
      - "${VNEXT_OUTBOX_PORT:-4204}:5000"
    <<: *vnext-common
  vnext-worker-outbox-dapr:
    image: "daprio/daprd:${DAPR_RUNTIME_VERSION:-latest}"
    container_name: vnext-worker-outbox-dapr-${DOMAIN_NAME:-core}
    profiles:
      - vnext
    command: [
      "./daprd",
      "--app-id", "vnext-worker-outbox-${DOMAIN_NAME:-core}",
      "--app-port", "5000",
      "--resources-path", "./components",
      "--dapr-grpc-port", "${DAPR_OUTBOX_GRPC_PORT:-45111}",
      "--dapr-http-port", "${DAPR_OUTBOX_HTTP_PORT:-45110}",
      "--scheduler-host-address", "dapr-scheduler:50007",
      "--placement-host-address", "dapr-placement:50005"
    ]
    volumes:
      - "../worker-outbox/dapr/components:/components"
    network_mode: "service:vnext-worker-outbox"
    depends_on:
      - vnext-worker-outbox
  # ============================================================================
  # INFRASTRUCTURE - Profile: infra
  # These services are shared by all domains and run as a single instance
  # ============================================================================
  dapr-placement:
    image: "daprio/dapr:${DAPR_PLACEMENT_VERSION:-latest}"
    container_name: dapr-placement
    profiles:
      - infra
    command: ["./placement"]
    ports:
      - "50005:50005"
    <<: *vnext-common
  dapr-scheduler:
    image: "daprio/scheduler:${DAPR_SCHEDULER_VERSION:-latest}"
    container_name: dapr-scheduler
    profiles:
      - infra
    user: "0:0"
    command: [
      "./scheduler",
      "--port",
      "50007",
      "--etcd-data-dir",
      "/data"
    ]
    ports:
      - "50007:50007"
    volumes:
      - type: tmpfs
        target: /data
        tmpfs:
          size: "64m"
          mode: 1777
    <<: *vnext-common
  redis:
    container_name: vnext-redis
    image: "redis:${REDIS_VERSION:-latest}"
    profiles:
      - infra
    restart: always
    ports:
      - '6379:6379'
    command: redis-server --save 20 1 --loglevel warning
    <<: *vnext-common
  postgres:
    container_name: vnext-postgres
    image: "postgres:${POSTGRES_VERSION:-latest}"
    profiles:
      - infra
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      PGDATA: /data/postgres
    volumes:
      - postgres:/data/postgres
      - ./config/postgres/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    <<: *vnext-common
  vault:
    container_name: vnext-vault
    image: "vault:${VAULT_VERSION:-1.13.3}"
    profiles:
      - infra
    restart: on-failure:10
    ports:
      - "8200:8200"
    environment:
      VAULT_ADDR: 'https://0.0.0.0:8200'
      VAULT_API_ADDR: 'https://0.0.0.0:8200'
      VAULT_DEV_ROOT_TOKEN_ID: 'admin'
      VAULT_TOKEN: 'admin'
    volumes:
      - ./config/vault:/vault/file
    cap_add:
      - IPC_LOCK
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--spider",
          "--proxy",
          "off",
          "http://vault:8200/v1/sys/health?standbyok=true",
        ]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    command: server -dev -dev-root-token-id="admin"
    <<: *vnext-common
  vault-prepopulate:
    image: "alpine/curl:${ALPINE_CURL_VERSION:-latest}"
    container_name: vault-prepopulate
    profiles:
      - infra
    depends_on:
      - vault
    volumes:
      - ./config/vault/vault.sh:/etc/vault/prepopulate_vault.sh
    command: ["sh", "-c", "chmod +x /etc/vault/prepopulate_vault.sh && /etc/vault/prepopulate_vault.sh"]
    <<: *vnext-common
  # OpenObserve for observability
  openobserve:
    container_name: vnext-openobserve
    image: "public.ecr.aws/zinclabs/openobserve:${OPENOBSERVE_VERSION:-latest}"
    profiles:
      - infra
    environment:
      ZO_ROOT_USER_EMAIL: "root@example.com"
      ZO_ROOT_USER_PASSWORD: "Complexpass#@123"
      ZO_DATA_DIR: "/data"
    ports:
      - "5080:5080"
    volumes:
      - openobserve:/data
    <<: *vnext-common
  # OpenTelemetry Collector
  otel-collector:
    container_name: vnext-otel-collector
    image: "otel/opentelemetry-collector-contrib:${OTEL_COLLECTOR_VERSION:-latest}"
    profiles:
      - infra
    volumes:
      - ./config/otel/otel-config.yaml:/etc/otelcol-contrib/config.yaml
    ports:
      - "1888:1888" # pprof extension
      - "8888:8888" # Prometheus metrics exposed by the Collector
      - "8889:8889" # Prometheus exporter metrics
      - "13133:13133" # health_check extension
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP http receiver
      - "55679:55679" # zpages extension
    depends_on:
      - openobserve
    <<: *vnext-common
  # Mockoon API Mock Server
  mockoon:
    image: mockoon/cli:${MOCKOON_VERSION:-latest}
    container_name: migration-mockoon
    profiles:
      - infra
    command: ["--data", "/data/migration-api.json", "--port", "3001", "--hostname", "0.0.0.0"]
    ports:
      - "3001:3001"
    volumes:
      - ./config/mockoon:/data
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    <<: *vnext-common
  mockoon-dapr:
    image: "daprio/daprd:${DAPR_RUNTIME_VERSION:-latest}"
    container_name: mockoon-dapr
    profiles:
      - infra
    command:
      [
        "./daprd",
        "--app-id", "mockoon",
        "--app-port", "3000",
        "--resources-path", "./components",
        "--dapr-grpc-port", "3501",
        "--dapr-http-port", "3500",
        "--scheduler-host-address", "dapr-scheduler:50007",
        "--placement-host-address", "dapr-placement:50005"
      ]
    volumes:
      - "../mockoon/dapr/components:/components"
    network_mode: "service:mockoon"
    depends_on:
      - mockoon
      - dapr-placement
      - dapr-scheduler
networks:
  vnext-development:
    external: true
volumes:
  postgres:
  openobserve:
  npm-cache-core: {}
  npm-cache-domain1: {}
  npm-cache-domain2: {}
  npm-cache-domain3: {}
  npm-cache-sales: {}
  npm-cache-hr: {}
  npm-cache-morph-idm: {}
